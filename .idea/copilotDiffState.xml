<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/FIRESTORE_INDEX_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/FIRESTORE_INDEX_GUIDE.md" />
              <option name="updatedContent" value="# Firestore Index Guide&#10;&#10;## ⚠️ LỖI HIỆN TẠI ĐÃ FIX&#10;&#10;**Lỗi:** `FAILED_PRECONDITION: The query requires an index`&#10;&#10;**Nguyên nhân:** Query sử dụng `whereArrayContains()` + `orderBy()` cần composite index.&#10;&#10;**Giải pháp đã áp dụng:** Bỏ `orderBy()` trong Firestore query, sort trên client-side (Java).&#10;&#10;---&#10;&#10;##  ĐÃ SỬA GÌ?&#10;&#10;### File: `ProjectRepository.java`&#10;&#10;#### 1. Method `getMyProjects()`&#10;**Trước:**&#10;```java&#10;db.collection(COLLECTION_PROJECTS)&#10;    .whereArrayContains(&quot;memberIds&quot;, currentUserId)&#10;    .orderBy(&quot;createdAt&quot;, Query.Direction.DESCENDING)  // ← CẦN INDEX&#10;    .get()&#10;```&#10;&#10;**Sau:**&#10;```java&#10;db.collection(COLLECTION_PROJECTS)&#10;    .whereArrayContains(&quot;memberIds&quot;, currentUserId)&#10;    // Bỏ orderBy()&#10;    .get()&#10;    .addOnSuccessListener(queryDocumentSnapshots -&gt; {&#10;        // ...&#10;        // Sort trên client-side&#10;        projects.sort((p1, p2) -&gt; {&#10;            if (p1.getCreatedAt() == null) return 1;&#10;            if (p2.getCreatedAt() == null) return -1;&#10;            return p2.getCreatedAt().compareTo(p1.getCreatedAt());&#10;        });&#10;    })&#10;```&#10;&#10;#### 2. Method `getProjectsCreatedByMe()`&#10;Tương tự, bỏ `orderBy()` và sort trên client.&#10;&#10;---&#10;&#10;##  SO SÁNH HIỆU NĂNG&#10;&#10;| Phương pháp | Ưu điểm | Nhược điểm |&#10;|-------------|---------|------------|&#10;| **Server-side sort (orderBy)** | ✅ Nhanh với data lớn&lt;br&gt;✅ Ít tốn RAM client | ❌ Cần tạo index&lt;br&gt;❌ Đợi index build |&#10;| **Client-side sort** | ✅ Không cần index&lt;br&gt;✅ Dễ implement | ❌ Chậm với &gt;1000 items&lt;br&gt;❌ Tốn RAM |&#10;&#10;**Với app hiện tại:** Client-side sort là đủ (mỗi user thường có &lt;100 projects).&#10;&#10;---&#10;&#10;##  NẾU MUỐN TẠO INDEX SAU NÀY&#10;&#10;### Bước 1: Copy link từ error message&#10;```&#10;https://console.firebase.google.com/v1/r/project/prm392-50020/firestore/indexes?create_composite=...&#10;```&#10;&#10;### Bước 2: Mở link trong browser&#10;- Đăng nhập Firebase Console&#10;- Firestore sẽ tự động điền thông tin index&#10;&#10;### Bước 3: Click &quot;Create Index&quot;&#10;- Đợi 2-10 phút để build&#10;- Status: Building → Enabled&#10;&#10;### Bước 4: Enable lại orderBy() trong code&#10;```java&#10;db.collection(COLLECTION_PROJECTS)&#10;    .whereArrayContains(&quot;memberIds&quot;, currentUserId)&#10;    .orderBy(&quot;createdAt&quot;, Query.Direction.DESCENDING)  // Giờ OK&#10;    .get()&#10;```&#10;&#10;### Bước 5: Xóa phần sort trên client&#10;```java&#10;// Xóa phần này&#10;projects.sort((p1, p2) -&gt; {&#10;    if (p1.getCreatedAt() == null) return 1;&#10;    if (p2.getCreatedAt() == null) return -1;&#10;    return p2.getCreatedAt().compareTo(p1.getCreatedAt());&#10;});&#10;```&#10;&#10;---&#10;&#10;##  COMPOSITE INDEX DETAILS&#10;&#10;Index cần tạo cho query `getMyProjects()`:&#10;&#10;```&#10;Collection: projects&#10;Fields:&#10;  - memberIds (ARRAY_CONTAINS)&#10;  - createdAt (DESCENDING)&#10;  - __name__ (DESCENDING)&#10;```&#10;&#10;Firestore tự động thêm `__name__` để đảm bảo ordering consistency.&#10;&#10;---&#10;&#10;##  KẾT LUẬN&#10;&#10;- ✅ **Hiện tại:** App chạy bình thường với client-side sort&#10;-  **Tương lai:** Nếu có nhiều projects (&gt;500), nên tạo index để tối ưu&#10;-  **Best practice:** Bắt đầu với client-side sort, scale lên server-side khi cần&#10;&#10;---&#10;&#10;##  TROUBLESHOOTING&#10;&#10;### Vẫn bị lỗi index khác?&#10;1. Check console log để xem query nào bị lỗi&#10;2. Copy link từ error message&#10;3. Tạo index trên Firebase Console&#10;4. Hoặc bỏ orderBy/where phức tạp và sort trên client&#10;&#10;### Index bị stuck ở &quot;Building&quot;?&#10;- Đợi thêm 10-30 phút&#10;- Nếu vẫn stuck, delete và tạo lại&#10;&#10;### Muốn xem tất cả indexes hiện có?&#10;Firebase Console → Firestore → Indexes tab&#10;&#10;---&#10;&#10;**Last updated:** November 8, 2025&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/FIX_INDEX_ERROR.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/FIX_INDEX_ERROR.md" />
              <option name="updatedContent" value="#  Fix cho lỗi Firestore Index&#10;&#10;## ✅ ĐÃ SỬA XONG!&#10;&#10;**Lỗi:** `FAILED_PRECONDITION: The query requires an index`&#10;&#10;**Fix:** Bỏ `orderBy()` trong Firestore query, sort trên Java client-side.&#10;&#10;---&#10;&#10;##  TEST NGAY&#10;&#10;1. **Restart app** (nếu đang chạy)&#10;2. **Đăng nhập**&#10;3. **Tab Project** → Danh sách projects sẽ hiển thị bình thường ✅&#10;4. **Tạo project mới** → Refresh danh sách → OK ✅&#10;&#10;---&#10;&#10;##  FILES ĐÃ SỬA&#10;&#10;- `ProjectRepository.java`&#10;  - Method: `getMyProjects()`&#10;  - Method: `getProjectsCreatedByMe()`&#10;&#10;**Thay đổi:**&#10;- ❌ Bỏ `.orderBy(&quot;createdAt&quot;, Query.Direction.DESCENDING)`&#10;- ✅ Thêm `projects.sort()` trên Java&#10;&#10;---&#10;&#10;##  TẠI SAO BỊ LỖI?&#10;&#10;Firestore yêu cầu **composite index** khi bạn combine:&#10;- `whereArrayContains()` + `orderBy()` trên field khác&#10;&#10;Index cần vài phút để build, nên tôi đã fix bằng cách sort trên client.&#10;&#10;---&#10;&#10;##  SAU NÀY NẾU MUỐN TỐI ƯU&#10;&#10;Khi có nhiều projects (&gt;500), có thể:&#10;1. Mở link trong error message&#10;2. Tạo index trên Firebase Console&#10;3. Enable lại `orderBy()` trong code&#10;&#10;Chi tiết xem: `FIRESTORE_INDEX_GUIDE.md`&#10;&#10;---&#10;&#10;**Status:** ✅ Fixed - Ready to test!&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>